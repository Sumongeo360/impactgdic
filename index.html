<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Task Gantt Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  margin: 0;
  font-family: "Times New Roman";
}

header {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  align-items: center;
  padding: 12px 20px;
  border-bottom: 1px solid #ccc;
}

header h2 {
  text-align: center;
  margin: 0;
}

.filters {
  text-align: center;
}

select {
  font-family: "Times New Roman";
  padding: 6px 10px;
  margin: 0 6px;
}

.dashboard {
  padding: 15px;
}

canvas {
  margin-bottom: 25px;
}
</style>
</head>

<body>

<header>
  <div></div>

  <h2>Project Task Dashboard</h2>

  <div class="filters">
    <select id="yearFilter">
      <option value="">Select Year</option>
    </select>
    <select id="productFilter">
      <option value="">Select Product</option>
    </select>
  </div>
</header>

<div class="dashboard">
  <canvas id="chartLeft"></canvas>
  <canvas id="chartRight"></canvas>
</div>

<script>
const SHEET_URL = "PASTE_YOUR_GOOGLE_SHEET_CSV_URL_HERE";

let rawData = [];
let chartLeft, chartRight;

/* ---------- DATA LOAD ---------- */
Papa.parse(SHEET_URL, {
  download: true,
  header: true,
  complete: res => {
    rawData = res.data.filter(r => r.Task);
    initFilters();
    autoPreFilterAndRender();
  }
});

/* ---------- FILTER SETUP ---------- */
function initFilters() {
  const years = [...new Set(rawData.map(d => d.Year))].sort();
  const yearSel = document.getElementById("yearFilter");

  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSel.appendChild(opt);
  });

  yearSel.onchange = () => {
    updateProductFilter();
    renderIfValid();
  };

  document.getElementById("productFilter").onchange = renderIfValid;
}

function updateProductFilter() {
  const year = yearFilter.value;
  const productSel = productFilter;
  productSel.innerHTML = '<option value="">Select Product</option>';

  if (!year) return;

  const products = [...new Set(
    rawData.filter(d => d.Year === year).map(d => d.Product)
  )];

  products.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    productSel.appendChild(opt);
  });
}

/* ---------- AUTO PREFILTER ---------- */
function autoPreFilterAndRender() {
  const latestYear = Math.max(...rawData.map(d => +d.Year));
  yearFilter.value = latestYear;

  updateProductFilter();

  const rows = rawData.filter(d => d.Year == latestYear);
  const latestProduct = rows.sort(
    (a,b) => new Date(b.Start) - new Date(a.Start)
  )[0].Product;

  productFilter.value = latestProduct;

  renderDashboard(latestYear, latestProduct);
}

/* ---------- RENDER CONTROL ---------- */
function renderIfValid() {
  const year = yearFilter.value;
  const product = productFilter.value;

  if (!year || !product) {
    destroyCharts();
    return;
  }
  renderDashboard(year, product);
}

function destroyCharts() {
  if (chartLeft) chartLeft.destroy();
  if (chartRight) chartRight.destroy();
}

/* ---------- CHART RENDER ---------- */
function renderDashboard(year, product) {
  destroyCharts();

  const data = rawData.filter(
    d => d.Year == year && d.Product == product
  );

  if (!data.length) return;

  const datasets = data.map(d => ({
    label: d.SubTask,
    data: [{
      x: [new Date(d.Start), new Date(d.End)],
      y: d.Task
    }],
    backgroundColor: d.Status === "Done" ? "#6cc070" : "#e57373"
  }));

  const commonOptions = extraRightPadding => ({
    indexAxis: "y",
    plugins: {
      datalabels: {
        anchor: "end",
        align: "right",
        color: "black",
        font: {
          family: "Times New Roman",
          size: 12
        },
        formatter: ctx => ctx.dataset.label
      },
      tooltip: {
        callbacks: {
          label: ctx => {
            const d = data[ctx.dataIndex];
            return [
              `Task: ${d.Task}`,
              `Assigned: ${d.Assigned}`,
              `Start: ${d.Start}`,
              `End: ${d.End}`,
              `Deadline: ${d.Deadline}`,
              `Status: ${d.Status}`
            ];
          }
        }
      },
      legend: { display: false }
    },
    scales: {
      x: {
        type: "time",
        min: Math.min(...data.map(d => new Date(d.Start))),
        max: new Date(
          Math.max(...data.map(d => new Date(d.End))) +
          extraRightPadding
        )
      },
      y: {
        stacked: true
      }
    }
  });

  chartLeft = new Chart(chartLeftCtx(), {
    type: "bar",
    data: { datasets },
    options: commonOptions(0)
  });

  chartRight = new Chart(chartRightCtx(), {
    type: "bar",
    data: { datasets },
    options: commonOptions(1000 * 60 * 60 * 24 * 10) // +10 days
  });
}

/* ---------- CTX HELPERS ---------- */
function chartLeftCtx() {
  return document.getElementById("chartLeft").getContext("2d");
}
function chartRightCtx() {
  return document.getElementById("chartRight").getContext("2d");
}
</script>

</body>
</html>
