<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Task Gantt Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  margin: 0;
  font-family: "Times New Roman";
}

header {
  display: grid;
  grid-template-columns: 1fr 2fr 1fr;
  align-items: center;
  padding: 12px 20px;
  border-bottom: 1px solid #ccc;
}

header h2 {
  margin: 0;
  text-align: center;
}

#prefilterInfo {
  text-align: center;
  font-size: 14px;
  margin-top: 4px;
}

.filters {
  text-align: right;
}

select {
  font-family: "Times New Roman";
  padding: 6px 10px;
  margin-left: 6px;
}

.dashboard {
  padding: 15px;
}

canvas {
  margin-bottom: 30px;
}
</style>
</head>

<body>

<header>
  <div></div>

  <div>
    <h2>Project Task Dashboard</h2>
    <div id="prefilterInfo"></div>
  </div>

  <div class="filters">
    <select id="yearFilter">
      <option value="">Select Year</option>
    </select>
    <select id="productFilter">
      <option value="">Select Product</option>
    </select>
  </div>
</header>

<div class="dashboard">
  <canvas id="chartLeft"></canvas>
  <canvas id="chartRight"></canvas>
</div>

<script>
const SHEET_URL = "PASTE_YOUR_GOOGLE_SHEET_CSV_URL_HERE";

let rawData = [];
let chartLeft, chartRight;

/* ---------- LOAD DATA ---------- */
Papa.parse(SHEET_URL, {
  download: true,
  header: true,
  complete: res => {
    rawData = res.data.filter(d => d.Task);
    initFilters();
    autoPreFilter();
  }
});

/* ---------- FILTER SETUP ---------- */
function initFilters() {
  const years = [...new Set(rawData.map(d => d.Year))].sort();
  const yearSel = document.getElementById("yearFilter");

  years.forEach(y => {
    const o = document.createElement("option");
    o.value = y;
    o.textContent = y;
    yearSel.appendChild(o);
  });

  yearSel.onchange = () => {
    updateProductFilter();
    renderIfValid();
  };

  productFilter.onchange = renderIfValid;
}

function updateProductFilter() {
  productFilter.innerHTML = `<option value="">Select Product</option>`;
  if (!yearFilter.value) return;

  [...new Set(
    rawData
      .filter(d => d.Year == yearFilter.value)
      .map(d => d.Product)
  )].forEach(p => {
    const o = document.createElement("option");
    o.value = p;
    o.textContent = p;
    productFilter.appendChild(o);
  });
}

/* ---------- AUTO PREFILTER ---------- */
function autoPreFilter() {
  const latestYear = Math.max(...rawData.map(d => +d.Year));
  yearFilter.value = latestYear;
  updateProductFilter();

  const latestRow = rawData
    .filter(d => d.Year == latestYear)
    .sort((a, b) => new Date(b.Start) - new Date(a.Start))[0];

  productFilter.value = latestRow.Product;

  updatePrefilterText(latestYear, latestRow.Product);
  renderDashboard(latestYear, latestRow.Product);
}

function updatePrefilterText(year, product) {
  document.getElementById("prefilterInfo").textContent =
    `Auto filtered â†’ Year: ${year} | Product: ${product}`;
}

/* ---------- RENDER CONTROL ---------- */
function renderIfValid() {
  if (!yearFilter.value || !productFilter.value) {
    destroyCharts();
    document.getElementById("prefilterInfo").textContent = "";
    return;
  }

  updatePrefilterText(yearFilter.value, productFilter.value);
  renderDashboard(yearFilter.value, productFilter.value);
}

function destroyCharts() {
  if (chartLeft) chartLeft.destroy();
  if (chartRight) chartRight.destroy();
}

/* ---------- DASHBOARD ---------- */
function renderDashboard(year, product) {
  destroyCharts();

  const rows = rawData.filter(
    d => d.Year == year && d.Product == product
  );
  if (!rows.length) return;

  const datasets = rows.map(d => ({
    label: d.SubTask || "",
    data: [{
      x: [new Date(d.Start), new Date(d.End)],
      y: d.Task
    }],
    backgroundColor: d.Status === "Done" ? "#6fbf73" : "#e57373"
  }));

  const baseOptions = extraRightMs => ({
    indexAxis: "y",
    plugins: {
      legend: { display: false },
      datalabels: {
        anchor: "end",
        align: "right",
        color: "black",
        font: {
          family: "Times New Roman",
          size: 12
        },
        formatter: (_, ctx) => {
          const label = ctx.dataset.label;
          return label ? label : "";
        }
      },
      tooltip: {
        callbacks: {
          label: ctx => {
            const d = rows[ctx.dataIndex];
            return [
              `Task: ${d.Task}`,
              `Assigned: ${d.Assigned}`,
              `Start: ${d.Start}`,
              `End: ${d.End}`,
              `Deadline: ${d.Deadline}`,
              `Status: ${d.Status}`
            ];
          }
        }
      }
    },
    scales: {
      x: {
        type: "time",
        min: Math.min(...rows.map(r => new Date(r.Start))),
        max: new Date(
          Math.max(...rows.map(r => new Date(r.End))) + extraRightMs
        )
      },
      y: {
        stacked: true
      }
    }
  });

  chartLeft = new Chart(
    document.getElementById("chartLeft"),
    { type: "bar", data: { datasets }, options: baseOptions(0) }
  );

  chartRight = new Chart(
    document.getElementById("chartRight"),
    { type: "bar", data: { datasets }, options: baseOptions(864000000) } // +10 days
  );
}
</script>

</body>
</html>
