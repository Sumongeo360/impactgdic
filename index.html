<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Products Journey Monitoring Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html,body{
  margin:0;padding:0;
  font-family:"Times New Roman",serif;
  background:#f2f2f2;
}

#topContainer{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 8px;
  background:#fff;
  min-height:70px;
  position:relative;
}

#centerTop{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}

#centerTop h1{
  font-size:18px;
  font-weight:bold;
  color:red;
  margin:0;
}

#controls{
  display:flex;
  gap:6px;
}

select,button{
  font-family:"Times New Roman",serif;
  font-size:11px;
  padding:2px 6px;
}

#rightTop img{
  height:48px;
}

#pendingTasksContainer{
  margin:4px 8px;
}

#pendingTasks{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}

.pending-item{
  background:#ffe0e0;
  border-left:4px solid #e74c3c;
  padding:2px 4px;
  font-size:11px;
  min-width:120px;
}

#dashboard{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:8px;
}

.column{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.chart-box{
  border-radius:6px;
  padding:4px;
  background:#f0f4c3;
}

canvas{width:100%!important}
</style>
</head>

<body>

<div id="topContainer">
  <div id="centerTop">
    <h1>Products Journey Monitoring Dashboard</h1>
    <div id="controls">
      <select id="yearFilter"><option value="">All Years</option></select>
      <select id="cropFilter"><option value="">All Crops</option></select>
      <button id="clearBtn">Clear</button>
    </div>
  </div>
  <div id="rightTop">
    <img src="images/delta-logo.png">
  </div>
</div>

<div id="pendingTasksContainer">
  <div id="pendingTasks"></div>
</div>

<div id="dashboard">
  <div id="leftColumn" class="column"></div>
  <div id="rightColumn" class="column"></div>
</div>

<script>
const CSV_URL="https://docs.google.com/spreadsheets/d/1B6Eca5B6RZgGzZqLQYX0MfaxTg3WyjWmnogahhA6iFw/gviz/tq?tqx=out:csv";
let rawData=[];
let cleared=true;

const yearFilter=document.getElementById("yearFilter");
const cropFilter=document.getElementById("cropFilter");
const clearBtn=document.getElementById("clearBtn");

fetch(CSV_URL)
.then(r=>r.text())
.then(csv=>{
  rawData=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
  initDefaultView();
});

yearFilter.onchange=applyFilter;
cropFilter.onchange=applyFilter;

clearBtn.onclick=()=>{
  cleared=true;
  yearFilter.value="";
  cropFilter.value="";
  updateCropOptions([]);
  clearDashboard();
};

function initDefaultView(){
  populateYears();
  const ctx=getLatestContext();
  if(!ctx) return;

  yearFilter.value=ctx.year;
  updateCropOptions(
    rawData.filter(d=>new Date(d.Task_Start).getFullYear()==ctx.year)
  );
  cropFilter.value=ctx.crop;

  cleared=false;
  applyFilter();
}

function getLatestContext(){
  const valid=rawData.filter(d=>d.Task_Start && d["Crops Covered"]);
  if(!valid.length) return null;

  valid.sort((a,b)=>new Date(b.Task_Start)-new Date(a.Task_Start));
  const latest=valid[0];

  return{
    year:new Date(latest.Task_Start).getFullYear(),
    crop:latest["Crops Covered"]
  };
}

function populateYears(){
  yearFilter.innerHTML='<option value="">All Years</option>';
  [...new Set(rawData.map(d=>new Date(d.Task_Start).getFullYear()).filter(Boolean))]
    .sort()
    .forEach(y=>{
      const o=document.createElement("option");
      o.value=y;o.textContent=y;
      yearFilter.appendChild(o);
    });
}

function updateCropOptions(data){
  cropFilter.innerHTML='<option value="">All Crops</option>';
  [...new Set(data.map(d=>d["Crops Covered"]).filter(Boolean))]
    .sort()
    .forEach(c=>{
      const o=document.createElement("option");
      o.value=c;o.textContent=c;
      cropFilter.appendChild(o);
    });
}

function applyFilter(){
  if(cleared) return;

  let filtered=rawData;

  if(yearFilter.value){
    filtered=filtered.filter(d=>new Date(d.Task_Start).getFullYear()==yearFilter.value);
  }

  updateCropOptions(filtered);

  if(cropFilter.value){
    filtered=filtered.filter(d=>d["Crops Covered"]===cropFilter.value);
  }

  buildDashboard(filtered);
  showPendingTasks(filtered);
}

function clearDashboard(){
  document.getElementById("leftColumn").innerHTML="";
  document.getElementById("rightColumn").innerHTML="";
  document.getElementById("pendingTasks").innerHTML="";
}

/* --- existing buildDashboard, drawGantt, showPendingTasks remain unchanged --- */
</script>

</body>
</html>
