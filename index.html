<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Products Journey Monitoring Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body{
  margin:0; padding:0;
  font-family:"Times New Roman", serif;
  background:#f2f2f2;
  height:100%;
  overflow-y:auto;
}

/* Top area container */
#topContainer{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 8px;
  background:#fff;
  min-height:70px;
  position:relative;
}

/* Center block: title + filters */
#centerTop{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}

/* Title */
#centerTop h1{
  font-size:18px;
  font-weight:bold;
  color:red;
  margin:0;
  text-align:center;
}

/* Filters row */
#controls{
  display:flex;
  gap:6px;
}

select, button{
  font-family:"Times New Roman", serif;
  font-size:11px;
  padding:2px 6px;
}

/* Right logo */
#rightTop{
  flex:0 0 10%; /* 1/10 of width */
  display:flex;
  justify-content:flex-end;
  align-items:center;
  z-index:1;
}

#rightTop img{
  height:48px; /* matches top bar height */
  width:auto;
}

/* Upcoming tasks section */
#pendingTasksContainer{
  margin:4px 8px;
}

#pendingTasksTitle{
  font-size:12px;
  font-weight:bold;
  margin-bottom:2px;
}

#pendingTasks{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}

.pending-item{
  background:#ffe0e0;
  border-left:4px solid #e74c3c;
  padding:2px 4px;
  border-radius:3px;
  line-height:1.2;
  text-align:center;
  font-size:11px;
  flex:1 1 calc(25% - 4px);
  min-width:120px;
}

/* Dashboard layout */
#dashboard{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:8px;
}

.column{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.chart-box{
  border-radius:6px;
  padding:4px;
  background:#f0f4c3;
}

canvas{
  width:100% !important;
}
</style>
</head>

<body>

<!-- Top area -->
<div id="topContainer">
  <div id="centerTop">
    <h1>Products Journey Monitoring Dashboard</h1>
    <div id="controls">
      <select id="yearFilter"><option value="">All Years</option></select>
      <select id="cropFilter"><option value="">All Crops</option></select>
      <button id="clearBtn">Clear</button>
    </div>
  </div>
  <div id="rightTop">
    <img src="images/delta-logo.png" alt="Delta Insurance Logo">
  </div>
</div>

<!-- Upcoming tasks -->
<div id="pendingTasksContainer">
  <div id="pendingTasksTitle">Upcoming (7 Days) Pending Task:</div>
  <div id="pendingTasks"></div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div id="leftColumn" class="column"></div>
  <div id="rightColumn" class="column"></div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/1B6Eca5B6RZgGzZqLQYX0MfaxTg3WyjWmnogahhA6iFw/gviz/tq?tqx=out:csv";
let rawData = [];

fetch(CSV_URL)
.then(r=>r.text())
.then(csv=>{
  rawData = Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
  populateFilters(rawData);
  buildDashboard(rawData);
  showPendingTasks(rawData);
});

const cropFilter = document.getElementById("cropFilter");
const yearFilter = document.getElementById("yearFilter");
const clearBtn   = document.getElementById("clearBtn");

cropFilter.addEventListener("change",applyFilter);
yearFilter.addEventListener("change",applyFilter);
clearBtn.addEventListener("click", ()=>{
  cropFilter.value=""; yearFilter.value="";
  buildDashboard(rawData);
  showPendingTasks(rawData);
});

function populateFilters(data){
  const years = [...new Set(data.map(d=>new Date(d.Task_Start).getFullYear()).filter(Boolean))].sort();
  years.forEach(y=>{
    const opt=document.createElement("option");
    opt.value=y; opt.textContent=y;
    yearFilter.appendChild(opt);
  });
  updateCropOptions(data);
}

function updateCropOptions(data){
  cropFilter.innerHTML='<option value="">All Crops</option>';
  const year = yearFilter.value;
  const filtered = year ? data.filter(d=>new Date(d.Task_Start).getFullYear()==year) : data;
  const crops = [...new Set(filtered.map(d=>d["Crops Covered"]).filter(Boolean))];
  crops.forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c; opt.textContent=c;
    cropFilter.appendChild(opt);
  });
}

function applyFilter(){
  let filtered = rawData;
  if(yearFilter.value) filtered = filtered.filter(d=>new Date(d.Task_Start).getFullYear()==yearFilter.value);
  updateCropOptions(rawData);
  if(cropFilter.value) filtered = filtered.filter(d=>d["Crops Covered"]===cropFilter.value);
  buildDashboard(filtered);
  showPendingTasks(filtered);
}

function showPendingTasks(data){
  const container = document.getElementById("pendingTasks");
  container.innerHTML="";
  const today = new Date();
  const next7 = new Date(); next7.setDate(today.getDate()+7);

  const upcoming = data.filter(d=>{
    const end = new Date(d.Task_End);
    return !isNaN(end) && end >= today && end <= next7 && d.Status!=="Completed";
  });

  if(!upcoming.length){
    container.innerHTML="<div>No pending tasks in next 7 days.</div>";
    return;
  }

  upcoming.forEach(task=>{
    const assigned = task.Assigned_To || "";
    const div = document.createElement("div");
    div.className="pending-item";
    div.textContent = `${task.Sub_Task && task.Sub_Task.trim()!=="" ? task.Sub_Task : task.Task}|${task.Client||""}|Deadline: ${task.Task_End}|${assigned}`;
    container.appendChild(div);
  });
}

function buildDashboard(data){
  const leftColumn = document.getElementById("leftColumn");
  const rightColumn = document.getElementById("rightColumn");
  leftColumn.innerHTML=""; rightColumn.innerHTML="";

  const policyRows = data.filter(r=>r.Major_Task==="Policy Start to End");
  const normalRows = data.filter(r=>r.Major_Task!=="Policy Start to End");

  const grouped = {};
  normalRows.forEach(r=>{
    if(!r.Major_Task || !r.Task_Start || !r.Task_End) return;
    grouped[r.Major_Task] ??= [];
    grouped[r.Major_Task].push(r);
  });

  const pastelColors = ["#dcedc8","#fff9c4","#ffe0b2","#f0f4c3","#c8e6c9","#e1bee7"];
  const majorTasks = Object.entries(grouped).slice(0,3);

  majorTasks.forEach(([major,rows],i)=>{
    const box=document.createElement("div"); 
    box.className="chart-box";
    box.style.background=pastelColors[i%pastelColors.length];
    const canvas=document.createElement("canvas"); 
    canvas.id="left_"+i;
    canvas.style.height="200px";
    box.appendChild(canvas); 
    leftColumn.appendChild(box);
    drawGantt(canvas.id, major, rows, false);
  });

  if(policyRows.length>0){
    const box=document.createElement("div"); 
    box.className="chart-box";
    box.style.background="#b3e5fc";
    const canvas=document.createElement("canvas"); 
    canvas.id="policyChart";
    const totalHeight = majorTasks.length*200;
    canvas.style.height=totalHeight+"px";
    box.appendChild(canvas); 
    rightColumn.appendChild(box);
    drawGantt(canvas.id, "Policy Start to End", policyRows, true);
  }
}

function drawGantt(id,title,rows,extendRight=false){
  const labels = rows.map(r=>r.Task);
  const ranges = rows.map(r=>{
    const start = new Date(r.Task_Start).getTime();
    let end = new Date(r.Task_End).getTime();
    if(end <= start) end = start + 86400000;
    return [start,end];
  });
  const colors = rows.map(r=>r.Status==="Done"?"#2ecc71":"#e74c3c");

  let minDate = Math.min(...ranges.map(r=>r[0]));
  let maxDate = Math.max(...ranges.map(r=>r[1]));

  if(extendRight) maxDate += 10*24*60*60*1000;

  new Chart(document.getElementById(id),{
    type:"bar",
    data:{labels,datasets:[{data:ranges,backgroundColor:colors,borderRadius:3,barPercentage:0.7}]},
    options:{
      indexAxis:"y",
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        title:{display:true,text:title,font:{size:12,weight:'bold',family:"Times New Roman"},color:"blue"},
        tooltip:{callbacks:{
          label:(ctx)=>{
            const r=rows[ctx.dataIndex]||{};
            return [
              "Task: "+(r.Task||""),
              "Sub Task: "+(r.Sub_Task||""),
              "Start: "+(r.Task_Start||""),
              "End: "+(r.Task_End||""),
              "Status: "+(r.Status||""),
              "Assigned: "+(r.Assigned_To||"")
            ];
          }
        }},
        datalabels:{
          display:true,
          color:'blue',
          font:{size:9,family:"Times New Roman"},
          anchor:'end',
          align:'end',
          formatter:(v,ctx)=>rows[ctx.dataIndex]?.Sub_Task||''
        }
      },
      scales:{
        x:{type:"time",min:minDate,max:maxDate,time:{unit:"day",tooltipFormat:"yyyy-MM-dd"},
          ticks:{font:{size:9,family:"Times New Roman"}, color:"blue",maxRotation:0,autoSkip:true}, grid:{color:"#eee"}},
        y:{ticks:{font:{size:9,family:"Times New Roman"}, color:"blue"}, grid:{display:false}}
      }
    },
    plugins:[ChartDataLabels]
  });
}
</script>

</body>
</html>

