<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Products Journey Monitoring Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
html, body{
  margin:0; padding:0;
  font-family:"Times New Roman", serif;
  background:#f2f2f2;
  height:100%;
  overflow-y:auto;
}

#topContainer{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 8px;
  background:#fff;
  min-height:70px;
  position:relative;
}

#centerTop{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}

#centerTop h1{
  font-size:18px;
  font-weight:bold;
  color:red;
  margin:0;
}

#controls{
  display:flex;
  gap:6px;
}

select, button{
  font-family:"Times New Roman", serif;
  font-size:11px;
  padding:2px 6px;
}

#rightTop img{
  height:48px;
}

#pendingTasksContainer{
  margin:4px 8px;
}

#pendingTasks{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}

.pending-item{
  background:#ffe0e0;
  border-left:4px solid #e74c3c;
  padding:2px 4px;
  border-radius:3px;
  font-size:11px;
  min-width:120px;
}

#dashboard{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:8px;
}

.column{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.chart-box{
  border-radius:6px;
  padding:4px;
  background:#f0f4c3;
}

canvas{
  width:100% !important;
}
</style>
</head>

<body>

<div id="topContainer">
  <div id="centerTop">
    <h1>Products Journey Monitoring Dashboard</h1>
    <div id="controls">
      <select id="yearFilter"></select>
      <select id="cropFilter"></select>
      <button id="clearBtn">Clear</button>
    </div>
  </div>
  <div id="rightTop">
    <img src="images/delta-logo.png">
  </div>
</div>

<div id="pendingTasksContainer">
  <div><b>Upcoming (7 Days) Pending Task:</b></div>
  <div id="pendingTasks"></div>
</div>

<div id="dashboard">
  <div id="leftColumn" class="column"></div>
  <div id="rightColumn" class="column"></div>
</div>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/1B6Eca5B6RZgGzZqLQYX0MfaxTg3WyjWmnogahhA6iFw/gviz/tq?tqx=out:csv";

let rawData = [];

const yearFilter = document.getElementById("yearFilter");
const cropFilter = document.getElementById("cropFilter");

fetch(CSV_URL)
.then(r=>r.text())
.then(csv=>{
  rawData = Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
  autoPrefilterAndRender();
});

document.getElementById("clearBtn").onclick = ()=>{
  yearFilter.innerHTML="";
  cropFilter.innerHTML="";
  document.getElementById("leftColumn").innerHTML="";
  document.getElementById("rightColumn").innerHTML="";
  document.getElementById("pendingTasks").innerHTML="";
};

yearFilter.onchange = applyFilter;
cropFilter.onchange = applyFilter;

/* ---------- AUTO PREFILTER ---------- */

function autoPrefilterAndRender(){
  const valid = rawData.filter(d=>d.Task_Start && d["Crops Covered"]);
  if(!valid.length) return;

  const latestYear = Math.max(...valid.map(
    d=>new Date(d.Task_Start).getFullYear()
  ));

  yearFilter.innerHTML=`<option value="${latestYear}">${latestYear}</option>`;

  const yearRows = valid.filter(
    d=>new Date(d.Task_Start).getFullYear()===latestYear
  );

  const latestRow = yearRows.sort(
    (a,b)=>new Date(b.Task_Start)-new Date(a.Task_Start)
  )[0];

  cropFilter.innerHTML=
    `<option value="${latestRow["Crops Covered"]}">
      ${latestRow["Crops Covered"]}
     </option>`;

  renderDashboard(
    yearRows.filter(d=>d["Crops Covered"]===latestRow["Crops Covered"])
  );
}

/* ---------- FILTER APPLY ---------- */

function applyFilter(){
  if(!yearFilter.value || !cropFilter.value){
    document.getElementById("leftColumn").innerHTML="";
    document.getElementById("rightColumn").innerHTML="";
    return;
  }

  const filtered = rawData.filter(d =>
    new Date(d.Task_Start).getFullYear()==yearFilter.value &&
    d["Crops Covered"]===cropFilter.value
  );

  renderDashboard(filtered);
}

/* ---------- DASHBOARD ---------- */

function renderDashboard(data){
  const left=document.getElementById("leftColumn");
  const right=document.getElementById("rightColumn");
  left.innerHTML="";
  right.innerHTML="";
  showPendingTasks(data);

  const policy = data.filter(d=>d.Major_Task==="Policy Start to End");
  const normal = data.filter(d=>d.Major_Task!=="Policy Start to End");

  const grouped={};
  normal.forEach(r=>{
    if(!r.Task_Start||!r.Task_End) return;
    grouped[r.Major_Task]??=[];
    grouped[r.Major_Task].push(r);
  });

  Object.entries(grouped).slice(0,3).forEach(([k,v])=>{
    const box=document.createElement("div");
    box.className="chart-box";
    const c=document.createElement("canvas");
    c.height=200;
    box.appendChild(c);
    left.appendChild(box);
    drawGantt(c,k,v,false);
  });

  if(policy.length){
    const box=document.createElement("div");
    box.className="chart-box";
    const c=document.createElement("canvas");
    c.height=600;
    box.appendChild(c);
    right.appendChild(box);
    drawGantt(c,"Policy Start to End",policy,true);
  }
}

/* ---------- PENDING ---------- */

function showPendingTasks(data){
  const el=document.getElementById("pendingTasks");
  el.innerHTML="";
  const today=new Date();
  const next7=new Date(); next7.setDate(today.getDate()+7);

  data.filter(d=>{
    const e=new Date(d.Task_End);
    return e>=today && e<=next7 && d.Status!=="Completed";
  }).forEach(t=>{
    const div=document.createElement("div");
    div.className="pending-item";
    div.textContent=
      `${t.Sub_Task||t.Task} | ${t.Assigned_To||""} | ${t.Task_End}`;
    el.appendChild(div);
  });
}

/* ---------- GANTT ---------- */

function drawGantt(canvas,title,rows,extendRight){
  const ranges = rows.map(r=>{
    const s=new Date(r.Task_Start).getTime();
    let e=new Date(r.Task_End).getTime();
    if(e<=s) e=s+86400000;
    return [s,e];
  });

  let min=Math.min(...ranges.map(r=>r[0]));
  let max=Math.max(...ranges.map(r=>r[1]));
  if(extendRight) max+=10*86400000;

  new Chart(canvas,{
    type:"bar",
    data:{
      labels:rows.map(r=>r.Task),
      datasets:[{
        data:ranges,
        backgroundColor:rows.map(r=>r.Status==="Done"?"#2ecc71":"#e74c3c"),
        borderRadius:3
      }]
    },
    options:{
      indexAxis:"y",
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        title:{
          display:true,
          text:title,
          color:"blue",
          font:{family:"Times New Roman",size:12,weight:"bold"}
        },
        datalabels:{
          anchor:"end",
          align:"right",
          color:"black",
          font:{family:"Times New Roman",size:11},
          formatter:(v,ctx)=>rows[ctx.dataIndex].Sub_Task||""
        },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const r=rows[ctx.dataIndex];
              return [
                `Task: ${r.Task}`,
                `Assigned: ${r.Assigned_To||""}`,
                `Start: ${r.Task_Start}`,
                `End: ${r.Task_End}`,
                `Status: ${r.Status}`
              ];
            }
          }
        }
      },
      scales:{ x:{type:"time",min,max} }
    },
    plugins:[ChartDataLabels]
  });
}
</script>

</body>
</html>
